---
title: "Seattle College Enrollments"
author: "Brian Holt"
date: "1/26/2020"
output:
  rmdformats::html_clean:
    TOC: yes
    highlight: kate
  pdf_document: default
  html_document:
    df_print: paged
---
```{r, packages and data,echo=F}
library(tidyverse)
library(lubridate)
library(dplyr)
```

```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r load data, include=TRUE}
load('seattle_col_enrol_thru_Win_2020.RData')
df <- df.tot
#rm(df.tot)
```

```{r stitch souths cancelled list, include =T}
load('main.df')
df.tot %>% filter(college == '064') %>% 
  mutate(cancel = 
           case_when
  )
  
}
#run qc code from read_enrollment to get list of codes
cancelled_items




```


```{r mutate college name, include =T}
df<- df %>% mutate(college=as.character(college)) %>% 
  mutate(college = as.factor(ifelse(college=='062',"Central",ifelse(college=='063',"North","South"))))

```

#Key things to be done:

1.confirm that the data matches a few of the website. 

##A small project tracking enrollments


##Some Data since 1985

```{r quick processing and graphing of enrollments,include =T}
df %>% filter(Season!='Summer',cancel==0) %>% select(Date,Enrolled,Season,college) %>% group_by(college,Date,Season) %>% 
  summarise(Quarter_enrollment_total=sum(Enrolled)) %>% 
  ggplot(aes(x=Date,y=Quarter_enrollment_total,color=Season))+geom_line()+#geom_smooth(method="loess")+
  facet_wrap(~college)
```

This table looks at the highest enrollment (around 2009) and compares the percentage drop among the colleges.

```{r, drop from high, echo=F }
df %>% select(Date,college,code, Season,yr,Enrolled,Cluster) %>% 
  mutate(Cluster=ifelse(is.na(Cluster)==T,'not clus','clus')) %>% group_by(college,Cluster,Date) %>% 
  summarise(max=max(sum(Enrolled))
            #recent_qrt= sum(Enrolled[code=='B902'])
            #Percent_drop=( round((max-recent_qrt)/max*100,1))
            ) %>% group_by(college) %>% summarise(max=max(max))


```




```{r calc enrolled by college over time, include=T,fig.dim=c(6,4)}
df %>% select(college,Date,code,Season,yr,Enrolled,cancel) %>% 
 filter(Season!="Summer", as.integer(yr)>00 & as.integer(yr)<30 ) %>% 
  group_by(college,Date,Season) %>% summarise(Total_enrolled=sum(Enrolled)) %>% 
  ggplot(aes(x=Date,y=Total_enrolled,color=Season))+geom_line()+facet_wrap(~college)+ggtitle("Total Enrollment over time")

```
  
```{r, prove that differences bw enrollof scrap vs site, comments=T}
  
##at some point would be worth confirming that the scrapped data looks like the calc'd data 

#summer 04 the 'new' AU codes went into effect

```  
  
```{r calc enrolled vs State FTE over time, include=T,fig.dim=c(6,4)}
df %>% select(college,Date,code,yr,Enrolled,State.FTES,Season) %>% 
    filter(Season!="Summer", as.integer(yr)>00 & as.integer(yr)<30 ) %>% group_by(college,Date) %>% 
  summarise(State_FTE_tot=sum(State.FTES)) %>% 
  ggplot(aes(x=Date,y=State_FTE_tot))+geom_line()+facet_grid(~college)+ggtitle("Total State FTE's")+geom_smooth()
#+theme(legend.position = "none")

```

##Questions?

Here is the data I have since 1985, what questions might you want answers to?

`r colnames(df)[-22]`


###Caveats:

**In 2004, the AU (administrative unit) codes changed, but this is how we'd track Division and program data.  I need to rig up some SQL to join this data to some titles from an excel table;

**The convention for tracking instructor names changes overtime making it hard to just pull out one person.  Ideally there would be a primary key for instructor, but that isn't trivial to create and using Employment ID is risky.

** I need to learn what the Pro and Org budgets mean. 

##What questions might you like?

How has nursing impacted FTE's since they moved to District? 


##Fill Ratio

After dropping classes where class size is equal to zero (about 52,300 of them, as opposed to 282,000 kept), and then dropping Summer classes, here is a graph showing the ratio of Enrolled classes to their class size, averaged for the year, displayed by Season, College, and year.

```{r, enrolled to class size ,include=T}
df %>% select(college,code,Season,yr,Date,Enrolled,Class.Size) %>% mutate(ratio=Enrolled/Class.Size,Date=year(Date)) %>% filter(ratio!=Inf,Season!="Summer") %>% group_by(college,Season,Date) %>% summarise(mean_ratio=mean(ratio)) %>% ggplot(aes(x=Date,y=mean_ratio,color=Season)) +geom_line()+facet_grid(~college)+ggtitle("")

```
